## Выявление факторов в рационах коров, влияющих на жирнокислотный состав молока

Инструмент для извлечения данных из рационов (PDF/Excel), построения предсказаний жирных кислот в молоке и интерпретации факторов рациона. Приложение работает офлайн, имеет десктопный интерфейс на PyQt6 и использует классические ML‑модели.

### Наша идея
- **Разделение данных**: нутриенты и ингредиенты требуют разных подходов.
- **Ансамблирование**: обучение нескольких моделей для отдельных групп признаков.
- **Стекинг/блендинг**: мета‑агрегация (усреднение) предсказаний от ансамблей нутриентов и ингредиентов.
- **Интерпретируемость**: предпочтение моделей и признаков с чёткой трактовкой влияния параметров.

### Реализация
- **OCR/парсинг PDF**: таблицы в PDF извлекаются через `camelot-py` (flavor="lattice").
- **Ансамбли моделей**:
  - по ингредиентам — набор `XGBRegressor` (16 моделей, по целевым кислотам), сохранённых в `parameters/xgb_output_*.json`;
  - по нутриентам — модель из `parameters/nutrients-_acids_01617_140.pkl` (scikit‑learn). Вход — признаки `Value_i`, извлекаемые из «Сводного анализа».
  - финальная оценка — усреднение предсказаний двух потоков.
- **UI (PyQt6)**: три вкладки — «Загрузка», «Предсказания», «Управление результатами» + «О программе». Есть экспорт результатов в DOCX/PDF и галерея подготовленных графиков.
- **Хранилище**: SQLite инициализируется автоматически.

### Результаты
- **ML‑метрики (валидация)**:
  - MSE: `0.1617`
  - R²: `0.878`
- **UI**:
  - интерактивные таблицы, визуализация распределений и трендов, экспорт отчётов.

### Интерпретация параметров (пример: стеариновая кислота)
- Наиболее значимым параметром является жом свекловичный: увеличение его содержания снижает стеариновую кислоту.
- Для различных сенажей характерно аналогичное влияние.
- У корнажей влияние слабее выражено, однако прослеживается рост значения при снижении процента СВ корнажа.

### Преимущества
- **Классический ML**: не нужны серьёзные вычислительные ресурсы и тяжёлые модели (вес приложения < 1 ГБ).
- **Высокая предсказательная способность**: с ростом выборки модель будет уточняться; можно детализировать факторы (сенажи/корнажи/силосы по культурам).
- **Интуитивный дизайн** приложения.
- **Оффлайн‑режим**.

---

## Структура проекта
- `app/app_desktop.py` — десктопный интерфейс на PyQt6: загрузка PDF/ручной ввод, запуск предсказаний, графики, экспорт в DOCX/PDF.
- `preprocessing/parser.py` — поиск таблиц Camelot, извлечение «Сводного анализа», преобразование значений к `Value_i`.
- `preprocessing/filtration.py` — словарь ингредиентов (`feed_types`), сопоставление названий → коды, агрегирование, списки признаков.
- `ingredient_model/pipeline.py` — загрузка ансамбля XGBoost (16 JSON), предсказания по ингредиентам.
- `nutrient_model/pipeline.py` — загрузка модели нутриентов (`*.pkl`), предсказания по подмножеству признаков `Value_i`.
- `utils/validation.py` — валидация рациона, проверка попадания в диапазоны ГОСТ.
- `database/db.py` — инициализация и работа с SQLite.
- `parameters/` — веса моделей: `xgb_output_*.json`, `nutrients-_acids_01617_140.pkl`, и др.
- `visuals/` — графики интерпретации.

## Установка
1) Убедитесь, что установлен Python 3.10+ (рекомендуется 3.12).

2) Клонируйте проект и установите зависимости:
```bash
python -m venv venv
source venv/bin/activate  # macOS/Linux
# venv\Scripts\activate  # Windows PowerShell
pip install -r requirements.txt
```

3) Системные зависимости для парсинга PDF:
- Установите правильный пакет: `pip install "camelot-py[cv]"`.
  - Если раньше ставили `camelot` (не тот пакет) — удалите его: `pip uninstall camelot`.
- Требуются утилиты для работы с PDF:
  - macOS: `brew install ghostscript poppler tesseract`
  - Ubuntu/Debian: `sudo apt-get install ghostscript poppler-utils tesseract-ocr`
  - Windows: установите Ghostscript и Poppler (см. документацию Camelot), по желанию Tesseract.

4) Модели должны лежать в `parameters/`:
- `xgb_output_0.json ... xgb_output_15.json`
- `nutrients-_acids_01617_140.pkl`

## Запуск
Из корня проекта `Cow-diet-fatty-acids/`:
```bash
python app/app_desktop.py
```
Приложение автоматически подбирает платформу Qt по ОС.

## Использование
1) Вкладка «Загрузка»:
   - Загрузите PDF с рационом. Парсер найдёт таблицу «Сводный анализ» и сформирует признаки
   - При необходимости отредактируйте значения ингредиентов (% СВ) и нутриентов.
   - Сохраните данные (создастся запись рациона в БД).
2) Вкладка «Предсказания»:
   - Нажмите «Сгенерировать предсказания». Две модели по ингредиентам и нутриентам посчитают значения; затем произойдёт усреднение.
   - Для каждой кислоты отображаются: значение (%), уровень по ГОСТу и условная «уверенность».
3) Вкладка «Управление результатами»:
   - Постройте гистограмму распределения.
   - Экспортируйте результаты в DOCX или PDF.
   - Просматривайте заготовленные графики из папки `visuals/`.

## Признаки и цели
- Целевые метрики: 16 жирных кислот (масляная, капроновая, каприловая, каприновая, деценовая, лауриновая, миристиновая, миристолеиновая, пальмитиновая, пальмитолеиновая, стеариновая, олеиновая, линолевая, линоленовая, арахиновая, бегеновая).
- Признаки по нутриентам: `Value_i`, извлекаемые из «Сводного анализа» 
- Признаки по ингредиентам: агрегированные доли по кодам `feed_types` (например, кукуруза плющеная, сенажи разных культур, жом свекловичный, др.).

## Экспорт отчётов
- DOCX: через `python-docx`.
- PDF: через `reportlab`.

Для корректного отображения кириллицы в PDF:
- положите файл шрифта `arial.ttf` в рабочую директорию (или замените в коде на установленный `DejaVuSans`),
- либо установите подходящий TTF‑шрифт и обновите регистрацию шрифта в `export_to_pdf`.

## Частые проблемы и решения
- «Camelot недоступен/не нашёл таблицы»: убедитесь, что установлен именно `camelot-py[cv]`, присутствуют Ghostscript и Poppler, а в PDF действительно есть таблица «Сводный анализ» с распознаваемыми границами.
- «Шрифт в PDF не отображает кириллицу»: поместите `arial.ttf` рядом с приложением или замените на другой TTF с кириллицей.
- «Некорректные числа после парсинга»: используйте интерфейс для ручной коррекции. В коде парсинга применяются функции нормализации числовых строк.

## Дисклеймер
Проект использует классические ML‑подходы и рассчитан на постепенное улучшение качества по мере накопления данных. При расширении набора данных возможно отдельно обучать модели для подтипов факторов (сенажи/корнажи/силосы по культурам) и/или настраивать мета‑агрегатор.


