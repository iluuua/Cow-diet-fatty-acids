# filtration.py
import re

acid_cols = [
    'Масляная', 'Капроновая', 'Каприловая', 'Каприновая', 'Деценовая',
    'Лауриновая', 'Миристиновая', 'Миристолеиновая', 'Пальмитиновая',
    'Пальмитолеиновая', 'Стеариновая', 'Олеиновая', 'Линолевая',
    'Линоленовая', 'Арахиновая', 'Бегеновая'
]

nutrient_cols = [
    'СП', 'ОЭ', 'aNDFom', 'КДК', 'ЧЭЛ 3x NRC', 'Сол. КП', 'Сахар (ВРУ)',
    'aNDFom фуража', 'peNDF', 'CHO C uNDF', 'Растворимая клетчатка',
    'Крахмал', 'RD Крахмал 3xУровень 1', 'НВУ', 'СЖ', 'ОЖК', 'Зола',
    'Ca', 'P', 'Mg', 'K', 'Na', 'S', 'Fe - всего', 'Масляная'
]

ingredient_cols = [

]

# основной справочник feed_types — дополняйте как нужно
feed_types = {
    '01': '05.06 зерно(кукуруза) плющенное',
    '02': '12.01 тритикале сенаж',
    '03': '10.01 однолетние травы сенаж',
    '04': 'патока свекловичная',
    '05': 'шрот соевый',
    '06': '05.02 зерно(кукуруза) силос',
    '07': 'жир защищенный',
    '08': '**.04 солома',
    '09': 'ячмень сухой',
    '10': '08.01 сенаж',
    '11': '01.01 люцерна сенаж',
    '12': 'кукуруза сухая',
    '13': '06.01 суданка сенаж',
    '14': 'сено',
    '15': 'жом свекловичный',
    '16': '03.01 сенаж',
    '17': 'комбикорм',
    '18': '16.01 сенаж',
    '19': '05.07 зерно(кукуруза) корнаж',
    '20': 'шрот рапсовый',
    '21': 'фураж',
    '22': '05.** кукуруза влажная',
    '23': 'жмых льняной',
    '24': '06.02 суданка силос',
    '25': 'пшеница',
    '26': 'дрожжи',
    '27': 'соевая оболочка',
    '28': 'дробина сухая',
    '29': '04.01 сенаж',
    '30': 'жмых рапсовый',
    '31': 'премикс дойный',
    '32': 'сода',
    '33': 'мел',
    '34': '13.01 рожь сенаж',
    '35': 'лед жнапкх добавка',
    '36': '02.01 сенаж',
    '37': 'шрот подсолнечный',
    '38': '07.01 сенаж',
    '39': 'соль',
    '40': '18.01 зерносмесь сенаж',
    '41': '09.01 клевер сенаж',
    '42': '05.01 зерно(кукуруза) сенаж',
    '43': 'поташ',
    '44': 'концентраты',
    '45': 'кальций пропионат',
}


def normalize(s: str) -> str:
    s = (s or '')
    s = str(s).lower()
    s = s.replace('\\', '/')
    s = re.sub(r'[^\S\r\n]+', ' ', s).strip()
    return s


def categorize_feed(feed_name: str):
    """
    Возвращает (code, label) по имени ингредиента. Простая, но расширяемая логика.
    """
    s = normalize(feed_name)
    if not s:
        return None, 'Не определено'

    # точные / ключевые слова
    keywords = {
        'патока': '04', 'меласса': '04',
        'шрот соев': '05', 'шрот рапсов': '20', 'шрот подсолнеч': '37',
        'жом свеклов': '15',
        'кукуруза': '12', 'плющ': '01', 'плющенное': '01',
        'корнаж': '19', 'силос': '06', 'сенаж': '10',
        'ячмень': '09', 'люцерна': '11', 'клевер': '41',
        'сено': '14', 'солома': '08', 'комбикорм': '17', 'кк': '17',
        'мел': '33', 'соль': '39', 'жир защищ': '07',
        'премикс': '31', 'поташ': '43', 'концентраты': '44',
        'жмых льнян': '23', 'жмых рапсов': '30', 'фураж': '21'
    }
    for k, code in keywords.items():
        if k in s:
            return code, feed_types.get(code, code)

    # номер-префикс NN.NN внутри строки -> попытка сопоставить по feed_types
    m = re.search(r'(\d{2}\.\d{2})', s)
    if m:
        pref = m.group(1)
        for code, label in feed_types.items():
            if pref in label:
                return code, label

    return None, 'Не определено'
